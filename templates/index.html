<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üóëÔ∏è Smart Garbage Detection System</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .control-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      height: fit-content;
    }

    .video-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      text-align: center;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .upload-area {
      border: 3px dashed #cbd5e0;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 25px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: #667eea;
      background-color: #f7fafc;
    }

    .upload-area.dragover {
      border-color: #667eea;
      background-color: #edf2f7;
    }

    .upload-icon {
      font-size: 3rem;
      color: #a0aec0;
      margin-bottom: 15px;
    }

    .upload-text {
      font-size: 1.1rem;
      color: #4a5568;
      margin-bottom: 10px;
    }

    .file-input {
      display: none;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 5px;
      text-decoration: none;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    }

    .btn-danger:hover {
      box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
    }

    .btn-success:hover {
      box-shadow: 0 10px 20px rgba(81, 207, 102, 0.3);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 25px;
    }

    .video-container {
      position: relative;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }

    .video {
      width: 100%;
      max-width: 800px;
      height: auto;
      border-radius: 15px;
      display: block;
    }

    .video-placeholder {
      width: 100%;
      height: 400px;
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #a0aec0;
    }

    .video-placeholder i {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .info-panels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 30px;
    }

    .info-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .info-panel h3 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .location-info {
      font-size: 0.95rem;
      line-height: 1.6;
      color: #4a5568;
    }

    .logs-container {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .log-item {
      background: #f7fafc;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }

    .log-time {
      font-weight: 600;
      color: #2d3748;
      font-size: 0.9rem;
    }

    .log-details {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #4a5568;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-online {
      background-color: #51cf66;
      animation: pulse 2s infinite;
    }

    .status-offline {
      background-color: #ff6b6b;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .info-panels {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-trash-alt"></i> Smart Garbage Detection System</h1>
      <p>AI-Powered Waste Management & Monitoring Solution</p>
    </div>

    <div class="main-content">
      <div class="control-panel">
        <h2 class="section-title">
          <i class="fas fa-cog"></i>
          Control Panel
        </h2>
        
        <div class="upload-area" onclick="document.getElementById('file-upload').click()">
          <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <div class="upload-text">Click to upload video file</div>
          <div id="selected-file-name" style="font-size: 0.9rem; color: #667eea; margin-top: 10px;"></div>
        </div>
        
        <input id="file-upload" type="file" class="file-input" name="file" accept="video/*" onchange="handleFileSelect(this)">
        
        <div class="btn-group">
          <button type="button" class="btn btn-success" onclick="uploadFile()">
            <i class="fas fa-upload"></i>
            Upload Video
          </button>
          
          <button type="button" class="btn" onclick="startCamera()">
            <i class="fas fa-video"></i>
            Start Camera
          </button>
          
          <button type="button" class="btn" onclick="startMobileCCTV()">
            <i class="fas fa-mobile-alt"></i>
            Mobile CCTV
          </button>
          
          <button type="button" class="btn btn-danger" onclick="stopDetection()">
            <i class="fas fa-stop"></i>
            Stop Detection
          </button>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="detection-count">0</div>
            <div class="stat-label">Detections</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="confidence-avg">0%</div>
            <div class="stat-label">Avg Confidence</div>
          </div>
        </div>
      </div>

      <div class="video-panel">
        <h2 class="section-title">
          <i class="fas fa-eye"></i>
          Live Detection Feed
        </h2>
        
        <div class="video-container">
          {% if file_path %}
            <img src="/video_feed?file={{ file_path }}" class="video" alt="Detection Feed">
          {% else %}
            <div class="video-placeholder">
              <i class="fas fa-play-circle"></i>
              <p>Select a video source to start detection</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="info-panels">
      <div class="info-panel">
        <h3>
          <i class="fas fa-map-marker-alt"></i>
          Location Information
        </h3>
        <div id="location-display" class="location-info">
          <div class="loading"></div> Loading location...
        </div>
        <div style="margin-top: 15px;">
          <button class="btn" onclick="loadLocation()" style="font-size: 0.9rem; padding: 8px 16px;">
            <i class="fas fa-sync-alt"></i>
            Refresh IP
          </button>
          <button class="btn" onclick="getMobileLocation()" style="font-size: 0.9rem; padding: 8px 16px;">
            <i class="fas fa-mobile-alt"></i>
            GPS Location
          </button>
        </div>
      </div>

      <div class="info-panel">
        <h3>
          <i class="fas fa-history"></i>
          Detection History
        </h3>
        <button class="btn" onclick="loadLogs()" style="font-size: 0.9rem; padding: 8px 16px; margin-bottom: 15px;">
          <i class="fas fa-refresh"></i>
          Refresh Logs
        </button>
        <button class="btn" onclick="generateJsonReport()" style="font-size: 0.9rem; padding: 8px 16px; margin-bottom: 15px;">
          <i class="fas fa-file-code"></i>
          Generate JSON Report
        </button>
        <div id="logs-display" class="logs-container">
          <p style="color: #a0aec0; text-align: center; padding: 20px;">No detections yet</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden forms for backend communication -->
  <form id="upload-form" method="POST" enctype="multipart/form-data" style="display: none;">
    <input id="hidden-file-input" type="file" name="file">
  </form>

  <form id="camera-form" method="POST" style="display: none;">
    <input type="hidden" name="camera" value="true">
  </form>

  <form id="ngrok-form" method="POST" style="display: none;">
    <input type="hidden" name="ngrok" value="true">
  </form>

  <form id="stop-form" action="/stop" method="POST" style="display: none;"></form>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALVkB5jfl6O0CLNBtGmaX87Kc6UBu2TLE",
      authDomain: "safai-saathi.firebaseapp.com",
      projectId: "safai-saathi",
      storageBucket: "safai-saathi.firebasestorage.app",
      messagingSenderId: "6015045092",
      appId: "1:6015045092:web:a31cf2a86330fac60d4bf1",
      measurementId: "G-ZMM65PNXCL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function saveModelResult(result) {
      try {
        const docRef = await addDoc(collection(db, "model_results"), {
          ...result,
          createdAt: serverTimestamp()
        });
        console.log("Saved to Firestore with ID:", docRef.id);
        return docRef.id;
      } catch (error) {
        console.error("Error saving model result:", error);
        throw error;
      }
    }

    // Make saveModelResult available globally
    window.saveModelResult = saveModelResult;
  </script>

  <script>
    let selectedFile = null;
    let detectionStats = { count: 0, confidence: 0 };

    // File handling functions
    function handleFileSelect(input) {
      if (input.files && input.files[0]) {
        selectedFile = input.files[0];
        document.getElementById('selected-file-name').innerHTML = 
          `<i class="fas fa-file-video"></i> ${selectedFile.name}`;
      }
    }

    function uploadFile() {
      if (selectedFile) {
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        fetch('/', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            location.reload();
          }
        })
        .catch(error => {
          console.error('Upload error:', error);
          alert('Upload failed. Please try again.');
        });
      } else {
        alert('Please select a file first.');
      }
    }

    function startCamera() {
      document.getElementById('camera-form').submit();
    }

    function startMobileCCTV() {
      document.getElementById('ngrok-form').submit();
    }

    function stopDetection() {
      fetch('/stop', { method: 'POST' })
        .then(() => {
          location.reload();
        })
        .catch(error => {
          console.error('Stop error:', error);
        });
    }

    // Drag and drop functionality
    const uploadArea = document.querySelector('.upload-area');
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const fileInput = document.getElementById('file-upload');
        fileInput.files = files;
        handleFileSelect(fileInput);
      }
    });

    // Location and detection log functions
    function loadLocation() {
      document.getElementById('location-display').innerHTML = '<div class="loading"></div> Loading...';
      
      fetch('/current_location')
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            document.getElementById('location-display').innerHTML = 
              `<div style="color: #e53e3e; padding: 10px; background: #fed7d7; border-radius: 8px;">
                <i class="fas fa-exclamation-triangle"></i> Error: ${data.error}
              </div>`;
          } else {
            const sourceIcon = data.source === 'GPS' ? 'üì±' : 'üåê';
            document.getElementById('location-display').innerHTML = 
              `<div style="background: #f7fafc; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                <div style="margin-bottom: 10px;">
                  <span class="status-indicator status-online"></span>
                  <strong>${sourceIcon} ${data.source || 'IP'} Location</strong>
                </div>
                <div style="margin: 5px 0;"><strong>IP:</strong> ${data.ip}</div>
                <div style="margin: 5px 0;"><strong>Location:</strong> ${data.city}, ${data.region}, ${data.country}</div>
                <div style="margin: 5px 0;"><strong>Coordinates:</strong> ${data.latitude?.toFixed(4)}, ${data.longitude?.toFixed(4)}</div>
                <div style="margin: 5px 0; font-size: 0.85rem; color: #718096;">
                  <i class="fas fa-clock"></i> ${new Date(data.timestamp).toLocaleString()}
                </div>
              </div>`;
          }
        })
        .catch(error => {
          document.getElementById('location-display').innerHTML = 
            '<div style="color: #e53e3e; padding: 10px; background: #fed7d7; border-radius: 8px;"><i class="fas fa-exclamation-triangle"></i> Error loading location</div>';
          console.error('Error:', error);
        });
    }

    // Get mobile GPS location using HTML5 Geolocation API
    function getMobileLocation() {
      if (navigator.geolocation) {
        document.getElementById('location-display').innerHTML = 
          '<div style="color: #3182ce; padding: 15px; background: #ebf8ff; border-radius: 10px; text-align: center;"><div class="loading"></div> Getting GPS location...</div>';
        
        navigator.geolocation.getCurrentPosition(
          function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            // Send GPS coordinates to server
            fetch('/save_gps_location', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                latitude: lat,
                longitude: lng,
                accuracy: accuracy,
                timestamp: new Date().toISOString()
              })
            })
            .then(response => response.json())
            .then(data => {
              document.getElementById('location-display').innerHTML = 
                `<div style="background: #f0fff4; padding: 15px; border-radius: 10px; border-left: 4px solid #38a169;">
                  <div style="margin-bottom: 10px;">
                    <span class="status-indicator status-online"></span>
                    <strong>üì± Mobile GPS Location</strong>
                  </div>
                  <div style="margin: 5px 0;"><strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
                  <div style="margin: 5px 0;"><strong>Accuracy:</strong> ¬±${accuracy.toFixed(0)} meters</div>
                  <div style="margin: 5px 0;"><strong>Address:</strong> ${data.address || 'Resolving...'}</div>
                  <div style="margin: 5px 0; font-size: 0.85rem; color: #718096;">
                    <i class="fas fa-clock"></i> ${new Date().toLocaleString()}
                  </div>
                </div>`;
            })
            .catch(error => {
              document.getElementById('location-display').innerHTML = 
                `<div style="background: #f0fff4; padding: 15px; border-radius: 10px; border-left: 4px solid #38a169;">
                  <div style="margin-bottom: 10px;">
                    <span class="status-indicator status-online"></span>
                    <strong>üì± Mobile GPS Location</strong>
                  </div>
                  <div style="margin: 5px 0;"><strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
                  <div style="margin: 5px 0;"><strong>Accuracy:</strong> ¬±${accuracy.toFixed(0)} meters</div>
                  <div style="margin: 5px 0; font-size: 0.85rem; color: #718096;">
                    <i class="fas fa-clock"></i> ${new Date().toLocaleString()}
                  </div>
                </div>`;
            });
          },
          function(error) {
            let errorMsg = '';
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMsg = "Location access denied by user";
                break;
              case error.POSITION_UNAVAILABLE:
                errorMsg = "Location information unavailable";
                break;
              case error.TIMEOUT:
                errorMsg = "Location request timed out";
                break;
              default:
                errorMsg = "Unknown error occurred";
                break;
            }
            document.getElementById('location-display').innerHTML = 
              `<div style="color: #e53e3e; padding: 15px; background: #fed7d7; border-radius: 10px;">
                <i class="fas fa-exclamation-triangle"></i> GPS Error: ${errorMsg}<br>
                <small>Please enable location services and try again.</small>
              </div>`;
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          }
        );
      } else {
        document.getElementById('location-display').innerHTML = 
          '<div style="color: #e53e3e; padding: 15px; background: #fed7d7; border-radius: 10px;"><i class="fas fa-exclamation-triangle"></i> Geolocation is not supported by this browser</div>';
      }
    }


    function loadLogs() {
      document.getElementById('logs-display').innerHTML = '<div class="loading"></div> Loading logs...';
      
      fetch('/location_logs')
        .then(response => response.json())
        .then(async data => {
          if (data.length === 0) {
            document.getElementById('logs-display').innerHTML = 
              '<div style="text-align: center; color: #a0aec0; padding: 20px;"><i class="fas fa-inbox"></i><br>No detections logged yet</div>';
          } else {
            let html = '';
            data.slice(-10).reverse().forEach(log => {
              const timestamp = new Date(log.timestamp).toLocaleString();
              const avgConfidence = log.confidence_scores.length > 0 ? 
                (log.confidence_scores.reduce((a, b) => a + b, 0) / log.confidence_scores.length * 100).toFixed(1) : 'N/A';
              
              const locationSource = log.location.source || 'IP';
              const locationIcon = locationSource === 'GPS' ? 'üì±' : 'üåê';
              const locationText = locationSource === 'GPS' ? 
                `GPS (${log.location.latitude?.toFixed(4)}, ${log.location.longitude?.toFixed(4)})` :
                `${log.location.city}, ${log.location.country}`;
              
              // Update stats
              detectionStats.count += log.detection_count;
              if (avgConfidence !== 'N/A') {
                detectionStats.confidence = (detectionStats.confidence + parseFloat(avgConfidence)) / 2;
              }
              
              html += `<div class="log-item">
                <div class="log-time">
                  <i class="fas fa-clock"></i> ${timestamp}
                </div>
                <div class="log-details">
                  <div style="margin: 5px 0;">
                    ${locationIcon} <strong>Location:</strong> ${locationText}
                  </div>
                  <div style="margin: 5px 0;">
                    <i class="fas fa-trash-alt"></i> <strong>Detections:</strong> ${log.detection_count} items
                  </div>
                  <div style="margin: 5px 0;">
                    <i class="fas fa-chart-line"></i> <strong>Confidence:</strong> ${avgConfidence}%
                  </div>
                </div>
              </div>`;
            });
            document.getElementById('logs-display').innerHTML = html;
            
            // Update stats display
            document.getElementById('detection-count').textContent = detectionStats.count;
            document.getElementById('confidence-avg').textContent = detectionStats.confidence.toFixed(1) + '%';

            // Auto-save latest detection data to Firebase if there are new logs
            if (data.length > 0 && window.saveModelResult) {
              try {
                const latestLog = data[data.length - 1];
                const detectionData = {
                  type: 'detection_log',
                  timestamp: latestLog.timestamp,
                  detection_count: latestLog.detection_count,
                  confidence_scores: latestLog.confidence_scores,
                  location: latestLog.location,
                  source: 'auto_save'
                };
                await window.saveModelResult(detectionData);
                console.log("Auto-saved latest detection to Firebase");
              } catch (error) {
                console.error("Error auto-saving detection to Firebase:", error);
              }
            }
          }
        })
        .catch(error => {
          document.getElementById('logs-display').innerHTML = 
            '<div style="color: #e53e3e; padding: 15px; background: #fed7d7; border-radius: 10px;"><i class="fas fa-exclamation-triangle"></i> Error loading logs</div>';
          console.error('Error:', error);
        });
    }

    function generateJsonReport() {
      fetch('/json_report')
        .then(response => response.json())
        .then(async data => {
          // Save JSON to Firestore
          try {
            if (window.saveModelResult) {
              const docId = await window.saveModelResult(data);
              console.log("Saved to Firestore with ID:", docId);
            }
          } catch (error) {
            console.error("Error saving to Firestore:", error);
          }

          // Display the JSON report in a modal or new window
          const jsonString = JSON.stringify(data, null, 2);
          
          // Create a modal to display the JSON
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
          `;
          
          const modalContent = document.createElement('div');
          modalContent.style.cssText = `
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
          `;
          
          const closeBtn = document.createElement('button');
          closeBtn.innerHTML = '‚úï';
          closeBtn.style.cssText = `
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
          `;
          closeBtn.onclick = () => document.body.removeChild(modal);
          
          const title = document.createElement('h3');
          title.innerHTML = '<i class="fas fa-file-code"></i> JSON Detection Report';
          title.style.cssText = 'margin-bottom: 20px; color: #2d3748;';
          
          const pre = document.createElement('pre');
          pre.style.cssText = `
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            overflow: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 500px;
          `;
          pre.textContent = jsonString;
          
          modalContent.appendChild(closeBtn);
          modalContent.appendChild(title);
          modalContent.appendChild(pre);
          modal.appendChild(modalContent);
          document.body.appendChild(modal);
          
          // Also copy to clipboard
          navigator.clipboard.writeText(jsonString).then(() => {
            alert('JSON report copied to clipboard and saved to Firebase!');
          });
        })
        .catch(error => {
          console.error('Error generating JSON report:', error);
          alert('Error generating JSON report');
        });
    }

    // Load location on page load
    window.onload = function() {
      // Try GPS location first, fallback to IP location
      if (navigator.geolocation) {
        getMobileLocation();
      } else {
        loadLocation();
      }
      
      // Load initial logs
      loadLogs();
      
      // Auto-refresh logs every 30 seconds when video is playing
      setInterval(function() {
        if (document.getElementsByClassName("video").length > 0) {
          loadLogs();
        }
      }, 30000);
    };
  </script>
</body>
</html>
